<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta name="viewport" content="initial-scale=1, maximum-scale=1">
<title>Portal Gun 3.0</title>
<link rel="stylesheet" type="text/css" href="portalstyle.css">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<div class="auto_margin">
<table class="auto_margin">
<tr>
<td><div id="gun_name_div"></div></td>
<td>
<select id="menuselecter" onchange="menu(this.value)">
<option value="preview">Home Screen</option>
<option value="load">Load Playlist</option>
<option value="custom">Custom Playlist</option>
<option value="settings">View Settings</option>
<option value="switch">Switch Guns</option>
<option value="reboot">Reboot Gun</option>
</select>
</td>
<td><div id="batt_div"></div></td>
<td><div id="temp_div"></div></td>
</tr>
</table>
<br>
<input type="button" class="button" id="primary_fire" value="Primary" onclick="post_button(100)"/>
<input type="button" class="button" id="alt_fire" value="Alt" onclick="post_button(101)"/>
<input type="button" class="button" id="mode_toggle" value="Mode" onclick="post_button(102)"/>
<input type="button" class="button" id="reset" value="Reset" onclick="post_button(103)"/>
<br>
<br>
<div class="hidden_div" id="imageWrapper"> 
<br>
<img class="portal_image" id="portal_back" alt="" onclick="capture_keyframe()" src="black.png">
<img class="portal_image" id="portal_front" alt="" src="black.png">
<svg id="portal_svg" width="240" height="240" viewBox="0 0 900 900" xmlns="http://www.w3.org/2000/svg">
<path id="portal_svg1" d="M 756.40902,784.0783 C 616.0042,905.68214 406.7082,935.38868 255.32421,855.20018 95.456062,770.51755 -14.28054,574.63033 1.5088513,402.12233 c 0.7212765,-7.88061 9.9179217,27.56439 18.6659637,71.94121 7.144324,36.24178 13.115668,58.30906 24.861546,78.0185 6.269958,10.5211 6.05171,10.08558 4.01957,2.16031 C -39.956792,207.09946 264.09254,-88.248872 593.22907,24.359284 914.50598,134.27856 1007.3874,566.70754 756.40902,784.0783 Z m 26.3128,-101.80801 c 11.1115,-16.00214 19.61599,-29.92739 25.06045,-43.92576 3.42873,-8.81569 2.62855,-9.94171 -9.91798,4.42425 -97.29734,111.40648 -241.34032,149.46671 -369.73254,95.95989 -10.90363,-4.54408 -10.40659,-4.79062 3.83466,-1.90211 178.69635,36.24486 346.73752,-71.53617 372.99635,-239.23868 28.98311,-185.10091 -131.06343,-382.66985 -337.576,-416.719266 -15.40391,-2.539801 -15.60922,-2.237873 -1.99385,2.93177 92.94107,35.289056 159.2535,96.896116 168.65244,156.684996 1.19408,7.59634 1.00593,10.8979 -0.36128,6.337 C 621.1429,204.98718 547.70656,146.46123 479.0548,123.58889 201.7575,31.203709 19.725511,327.98554 183.57947,605.32674 c 128.859,218.10822 375.55268,273.9781 554.84391,126.02091 4.36065,-3.59853 15.70861,-14.3553 16.66543,-15.57231 5.38114,-6.84445 21.44862,-24.59842 27.63301,-33.50505 z" fill="orange" stroke-width="0" />
<use id="use" xlink:href="#c1" />
</svg>
<div id="portal_text"></div>
</div>
<div class="hidden_div" id="playlist_div"> 
<div id="connected_div"></div>
<br>
<table>
<tr>
<td class="table_top"><div id="playlist_duo_text"></div></td>
<td class="table_top"><div id="playlist_solo_text"></div></td>
</tr>
</table>
</div>
<div class="hidden_div" id="settings_div"> 
<br>
Nightvision Brightness:
<select id="ir_select" onchange="ir_select_onchange(this)">
<option value="1025">?</option>
<option value="1024">1024</option>
<option value="255">255</option>
<option value="128">128</option>
<option value="64">64</option>
<option value="32">32</option>
<option value="0">0</option>
</select>
<br>
<br>
Camera Preview:
<select id="preview_camera_select" onchange="preview_camera_onchange(this)">
<option value="LIVE">LIVE</option>
<option value="GIF">GIF</option>
<option value="OFF">OFF</option>
</select>
</select>
<br>
<br>
Projector Preview:
<select id="preview_projection_select" onchange="preview_projection_onchange(this)">
<option value="LIVE">LIVE</option>
<option value="GIF">GIF</option>
<option value="OFF">OFF</option>
</select>
<br>
<br>
Updates Per Minute:
<select id="update_speed_select" onchange="update_speed_onchange(this)">
<option value="200">300</option>
<option value="500">120</option>
<option value="1000">60</option>
<option value="5000">12</option>
</select>
<br>
<br>
Portal Type:
<select id="portal_type_select" onchange="portal_type_onchange(this)">
<option value="SVG">SVG</option>
<option value="GIF">GIF</option>
<option value="PNG">PNG</option>
</select>
<br>
<br>
WiFi Channel:
<select id="wifi_channel_select" onchange="wifi_channel_onchange(this)">
<option value="-">-</option>
<option value="36">36</option>
<option value="44">44</option>
<option value="149">149</option>
<option value="157">157</option>
<option value="165">165</option>
</select><br><br>
<input type="button" class="button_text" id="hdmifix" onclick="hdmifix()" value="HDMI Reset"/><br><br>
<input type="button" class="button_text" id="rebootgun" onclick="reboot()" value="Reboot"/><br>
</div>
<div class="hidden_div" id="load_div"> 
<br>
<table>
<tr>
<td class="centertop"><div>
<b><u>DUO PLAYLISTS</u></b><br>
<input type="button" class="button_text" onclick="playlist_load(5)" value="Empty Duo"/><br>
<input type="button" class="button_text" onclick="playlist_load(6)" value="TV Effect"/><br>
<input type="button" class="button_text" onclick="playlist_load(7)" value="GL Effect"/><br>
<input type="button" class="button_text" onclick="playlist_load(8)" value="Blend 1"/><br>
<input type="button" class="button_text" onclick="playlist_load(9)" value="Partner 1"/><br>
<input type="button" class="button_text" onclick="playlist_load(10)" value="Partner 2"/><br>
<input type="button" class="button_text" onclick="playlist_load(11)" value="Party 1"/><br>
<input type="button" class="button_text" onclick="playlist_load(12)" value="Party 2"/><br>
<input type="button" class="button_text" onclick="playlist_load(13)" value="Party 3"/><br>
<input type="button" class="button_text" onclick="playlist_load(14)" value="Alternate"/><br>
</div></td>
<td class="centertop"><div>
<b><u>SOLO PLAYLISTS</u></b><br>
<input type="button" class="button_text" onclick="playlist_load(1)" value="Empty Solo"/><br>
<input type="button" class="button_text" onclick="playlist_load(2)" value="Music"/><br>
<input type="button" class="button_text" onclick="playlist_load(3)" value="Clips"/><br>
<input type="button" class="button_text" onclick="playlist_load(4)" value="Audio Vis."/><br>
</div></td>
</tr>
</table>
</div>
<div class="hidden_div" id="custom_div"> 
Select Item to Edit...<br><br>
<table>
<tr>
<td class="centertop">
<b><u>DUO PLAYLIST</u></b><br>
<input type="button" class="button_text" id="duo0" onclick="edit_playlist(0,1)" value="-"/><br>
<input type="button" class="button_text" id="duo1" onclick="edit_playlist(1,1)" value="-"/><br>
<input type="button" class="button_text" id="duo2" onclick="edit_playlist(2,1)" value="-"/><br>
<input type="button" class="button_text" id="duo3" onclick="edit_playlist(3,1)" value="-"/><br>
<input type="button" class="button_text" id="duo4" onclick="edit_playlist(4,1)" value="-"/><br>
<input type="button" class="button_text" id="duo5" onclick="edit_playlist(5,1)" value="-"/><br>
<input type="button" class="button_text" id="duo6" onclick="edit_playlist(6,1)" value="-"/><br>
<input type="button" class="button_text" id="duo7" onclick="edit_playlist(7,1)" value="-"/><br>
<input type="button" class="button_text" id="duo8" onclick="edit_playlist(8,1)" value="-"/><br>
<input type="button" class="button_text" id="duo9" onclick="edit_playlist(9,1)" value="-"/><br>
</td>
<td class="centertop">
<b><u>SOLO PLAYLIST</u></b><br>
<input type="button" class="button_text" id="solo0" onclick="edit_playlist(0,0)" value="-"/><br>
<input type="button" class="button_text" id="solo1" onclick="edit_playlist(1,0)" value="-"/><br>
<input type="button" class="button_text" id="solo2" onclick="edit_playlist(2,0)" value="-"/><br>
<input type="button" class="button_text" id="solo3" onclick="edit_playlist(3,0)" value="-"/><br>
<input type="button" class="button_text" id="solo4" onclick="edit_playlist(4,0)" value="-"/><br>
<input type="button" class="button_text" id="solo5" onclick="edit_playlist(5,0)" value="-"/><br>
<input type="button" class="button_text" id="solo6" onclick="edit_playlist(6,0)" value="-"/><br>
<input type="button" class="button_text" id="solo7" onclick="edit_playlist(7,0)" value="-"/><br>
<input type="button" class="button_text" id="solo8" onclick="edit_playlist(8,0)" value="-"/><br>
<input type="button" class="button_text" id="solo9" onclick="edit_playlist(9,0)" value="-"/><br>
</td>
</tr>
</table>
</div>
<div class="hidden_div" id="edit_div"> 
<input type="button" class="button_text" onclick="save_playlist()" value="Save Changes"/>
<input type="button" class="button_text" onclick="menu('custom')" value="Discard Changes"/><br><br>
<input type="button" onclick="edit_change(-1)" value="<-"/>
<div id="playlist_duo_div"> 
<select id="playlist_duo_select" onchange="playlist_onchange(this)">
<optgroup label="Effects">
<option value="4">4</option>
<option value="19">19</option>
<option value="20">20</option>
<option value="21">21</option>
<option value="22">22</option>
<option value="23">19</option>
<option value="24">24</option>
<option value="25">25</option>
<option value="26">26</option>
<option value="27">27</option>
<option value="28">28</option>
<option value="29">29</option>
<option value="30">30</option>
<option value="31">31</option>
<option value="32">32</option>
<option value="33">33</option>
<option value="34">34</option>
<option value="35">35</option>
<option value="36">36</option>
<option value="37">37</option>
</optgroup> 
<optgroup label="Audio">
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
<option value="13">13</option>
<option value="14">14</option>
<option value="15">15</option>
</optgroup> 
<optgroup label="Test">
<option value="-1">-1</option>
<option value="0">0</option>
<option value="1">1</option>
<option value="2">2</option>
</optgroup> 
<optgroup label="Movies">
<option value="50">50</option>
<option value="51">51</option>
<option value="52">52</option>
<option value="53">53</option>
<option value="54">54</option>
<option value="55">55</option>
<option value="56">56</option>
<option value="57">57</option>
<option value="58">58</option>
<option value="59">59</option>
<option value="60">60</option>
<option value="61">61</option>
</optgroup>
</select>
</div>
<div id="playlist_solo_div"> 
<select id="playlist_solo_select" onchange="playlist_onchange(this)">
<optgroup label="Audio">
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
<option value="13">13</option>
<option value="14">14</option>
<option value="15">15</option>
</optgroup> 
<optgroup label="Test">
<option value="-1">-1</option>
<option value="0">0</option>
<option value="1">1</option>
<option value="2">2</option>
</optgroup> 
<optgroup label="Movies">
<option value="50">50</option>
<option value="51">51</option>
<option value="52">52</option>
<option value="53">53</option>
<option value="54">54</option>
<option value="55">55</option>
<option value="56">56</option>
<option value="57">57</option>
<option value="58">58</option>
<option value="59">59</option>
<option value="60">60</option>
<option value="61">61</option>
</optgroup>
</select>
</div>
<input type="button" onclick="edit_change(1)" value="->"/>
<br>
<img id="custom_preview" alt="" src="blank.png">
</div>
</div>
<script>
//global timer object
var interval_obj;

//load cookie stuff
var preview_camera = getCookie("preview_camera");
if (preview_camera == ""){
	setCookie("preview_camera", "LIVE", 365);
	preview_camera = "LIVE";
}
preview_camera_select.value = preview_camera;

var preview_project = getCookie("preview_project");
if (preview_project == ""){
	setCookie("preview_project", "LIVE", 365);
	preview_project = "LIVE";
}
preview_projection_select.value = preview_project;

var update_rate = getCookie("update_rate");
if (update_rate == ""){
	setCookie("update_rate", "200", 365);
	update_rate = 200;
}else{
	update_rate = parseInt(update_rate);
}
update_speed_select.value = update_rate;

var portal_type = getCookie("portal_type");
if (portal_type == ""){
	setCookie("portal_type", "SVG", 365);
	portal_type = "SVG";
}
portal_type_select.value = portal_type;

var gunmode = -1;
var portal_color = -1;
var loading = 1;
var latency_last = -1;
var effect_solo = -1;
var effect_duo = -1;
var core_temp_last = -1;
var last_packet_counter = -1;
var missed_packets = 3;
var requested_mode = "preview";
var connected_last = -1;
var ir_pwm_last = -1;
var state_duo = -1;
var state_duo_last = -1;
var state_solo = -1;
var state_solo_last = -1;

var effect_solo_last = -22;
var effect_duo_last = -22;

var playlist_solo_array = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
var playlist_solo_array_index_last = -1;
var playlist_duo_array = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
var playlist_duo_array_index_last = -1;

var arduino_battery_level_last = -1;
var arduino_temp_last = -1;

var edit_num = -11;
var custom_mode = -11;

//populate playlist options
for(var i=0; i < playlist_solo_select.length; i++){
	playlist_solo_select.options[i].text = effect_name(parseInt(playlist_solo_select.options[i].value));
}
for(var i=0; i < playlist_duo_select.length; i++){
	playlist_duo_select.options[i].text = effect_name(parseInt(playlist_duo_select.options[i].value));
}

menuselecter.value = "preview";

if (location.host == "192.168.1.20"){gun_name_div.innerHTML = "Gordon";}
else if (location.host == "192.168.1.21"){gun_name_div.innerHTML = "Chell";}
else if (location.host.indexOf(":8020") > 0){gun_name_div.innerHTML = "Gordon";}
else if (location.host.indexOf(":8021") > 0){gun_name_div.innerHTML = "Chell";}


update_data();
var clicktime = 0;

function capture_keyframe(){
	if (Date.now() - clicktime < 500){
		var request = new XMLHttpRequest();
		request.onerror = function() {
			setTimeout(capture_keyframe,400);
		}
		request.onload = function() {
			if (parseInt(this.response) == 1){
				portal_back.src = "/assets/shutter.png";
				setTimeout(check_if_keyframe_complete,300);
			}
		}
		request.open("GET", "http://127.0.0.1:9000/set", true);
		request.send(null);
	}
	clicktime = Date.now();
}
function check_if_keyframe_complete(){
	var request = new XMLHttpRequest();
	request.onerror = function() {
		setTimeout(check_if_keyframe_complete,400);
	}
	request.onload = function() {
		if (parseInt(this.response) == 0){
			update_portal_background();
		}else{
			setTimeout(check_if_keyframe_complete,400);
		}
	}
	request.open("GET", "http://127.0.0.1:9000", true);
	request.send(null);
}
function playlist_load(num){
	switch(num) {
	case 1:
		post_text('mode=3 2 -1 -1 -1 -1 -1 -1 -1 -1 -1');
		requested_mode = "custom";
		break;
	case 2:
		post_text('mode=3 60 61 -1 -1 -1 -1 -1 -1 -1 -1');
		requested_mode = "custom";
		break;
	case 3:	
		post_text('mode=3 50 51 52 53 54 55 56 57 58 59');
		requested_mode = "custom";
		break;
	case 4:	
		post_text('mode=3 14 15 10 11 12 13 -1 -1 -1 -1');
		requested_mode = "custom";
		break;
	case 5:	
		post_text('mode=4 4 -1 -1 -1 -1 -1 -1 -1 -1 -1');
		requested_mode = "custom";
		break;
	case 6:	
		post_text('mode=4 4 19 20 21 22 23 24 25 26 27');
		requested_mode = "custom";
		break;
	case 7:	
		post_text('mode=4 30 28 29 37 31 32 33 34 35 36');
		requested_mode = "custom";
		break;
	case 8:	
		post_text('mode=4 4 20 19 29 37 30 24 25 28 31');
		requested_mode = "custom";
		break;
	case 9:	//back forth1
		post_text('mode=4 20 25 19 23 28 33 36 -1 -1 -1');
		requested_mode = "custom";
		break;
	case 10://back forth2
		post_text('mode=4 22 29 37 21 27 31 32 35 -1 -1');
		requested_mode = "custom";
		break;
	case 11://party 1
		post_text('mode=4 20 24 37 29 30 26 19 -1 -1 -1');
		requested_mode = "custom";
		break;
	case 12://party 2
		post_text('mode=4 20 15 24 11 37 10 29 14 30 13');
		requested_mode = "custom";
		break;
	case 13://party 3
		post_text('mode=4 10 29 14 30 13 20 15 24 11 37');
		requested_mode = "custom";
		break;
	case 14://party 3
		post_text('mode=4 4 20 4 37 4 29 4 30 4 31');
		requested_mode = "custom";
		break;
	}
	mode_set();
}
function portal_type_onchange(object){
	portal_type = object.options[object.selectedIndex].value;
	setCookie("portal_type", portal_type, 365);
}
function preview_camera_onchange(object){
	preview_camera = object.options[object.selectedIndex].value;
	setCookie("preview_camera", preview_camera, 365);
	update_portal_background();
}
function preview_projection_onchange(object){
	preview_project = object.options[object.selectedIndex].value;
	setCookie("preview_project", preview_project, 365);
	update_portal_background();
}
function update_speed_onchange(object){
	update_rate = object.options[object.selectedIndex].value;
	setCookie("update_rate", update_rate, 365);
	clearTimeout(interval_obj);
	interval_obj = setTimeout(update_data,update_rate);
}
function playlist_onchange(thing){
	custom_preview.src = effect_preview(thing.value);
}
function effect_preview(num){
	return "/assets/" + num + ".gif";
}
function update_custom_buttons(){
	duo0.value = effect_name(playlist_duo_array[0]);
	duo1.value = effect_name(playlist_duo_array[1]);
	duo2.value = effect_name(playlist_duo_array[2]);
	duo3.value = effect_name(playlist_duo_array[3]);
	duo4.value = effect_name(playlist_duo_array[4]);
	duo5.value = effect_name(playlist_duo_array[5]);
	duo6.value = effect_name(playlist_duo_array[6]);
	duo7.value = effect_name(playlist_duo_array[7]);
	duo8.value = effect_name(playlist_duo_array[8]);
	duo9.value = effect_name(playlist_duo_array[9]);
	solo0.value = effect_name(playlist_solo_array[0]);
	solo1.value = effect_name(playlist_solo_array[1]);
	solo2.value = effect_name(playlist_solo_array[2]);
	solo3.value = effect_name(playlist_solo_array[3]);
	solo4.value = effect_name(playlist_solo_array[4]);
	solo5.value = effect_name(playlist_solo_array[5]);
	solo6.value = effect_name(playlist_solo_array[6]);
	solo7.value = effect_name(playlist_solo_array[7]);
	solo8.value = effect_name(playlist_solo_array[8]);
	solo9.value = effect_name(playlist_solo_array[9]);
}
function reinit_all(){
	//set everything to impossible values to force state change on next load
	portal_color = -1;
	loading = 1;
	latency_last = -1;
	core_temp_last = -1;
	requested_mode = "preview";
	connected_last = -1;
	state_duo = -1;
	state_duo_last = -1;
	state_solo = -1;
	state_solo_last = -1;
	ir_pwm_last = -1;
	effect_solo_last = -1;
	playlist_solo_array_index_last = -1;
	effect_duo_last = -1;
	playlist_duo_array_index_last = -1;
	playlist_solo_array = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
	playlist_duo_array = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];
	arduino_battery_level_last = -1;
	arduino_temp_last = -1;
	
	primary_fire.style.backgroundColor = "";
	primary_fire.style.color = "transparent";		
	alt_fire.style.backgroundColor = "";
	alt_fire.style.color = "transparent";	

	
	mode_set();
}
function menu(sel){
	if (sel == "switch"){	
		if (location.host == "192.168.1.21"){
			window.location.href = 'http://192.168.1.20';
		}
		else if (location.host == "192.168.1.20"){
			window.location.href = 'http://192.168.1.21';
		}
		else if (location.host.indexOf(":8020") > 0){
			var temp = location.host;
			window.location.href = 'http://' + temp.replace(":8020", ":8021");
		}
		else if (location.host.indexOf(":8021") > 0){
			var temp = location.host;
			window.location.href = 'http://' + temp.replace(":8021", ":8020");
		}
		
	}else{
		if (sel == "reboot"){
			var r = confirm("Are you sure?");
			if (r == true) {
				missed_packets = 999;
				update_data();
				var request = new XMLHttpRequest();
				request.open("GET", "reboot.php", true);
				request.send(null);
			}
			sel = "preview";
		}
		requested_mode = sel;
		mode_set();
	}
}
function hdmifix(){
	var r = confirm("Are you sure?");
		if (r == true) {
			var request = new XMLHttpRequest();
			request.open("GET", "hdmifix.php", true);
			request.send(null);
		}
}
function edit_change(inputnum){
	var obj = custom_mode ? playlist_duo_select : playlist_solo_select;
	var new_index = obj.selectedIndex + inputnum;
	if (new_index < 0){
		new_index = obj.length - 1;
	}
	if (new_index >=  obj.length){ 
		new_index = 0;
	}
	obj.selectedIndex = new_index;
	playlist_onchange(obj);
}
function edit_playlist( effect_num, mode ){
	playlist_solo_div.style.display  = 'none';  
	playlist_duo_div.style.display  = 'none';  
	if (mode == 1){
		playlist_duo_select.value = playlist_duo_array[effect_num].toString();
		playlist_duo_div.style.display  = 'inline'; 
		playlist_onchange(playlist_duo_select);
	}else if (mode == 0){
		playlist_solo_select.value = playlist_solo_array[effect_num].toString();
		playlist_solo_div.style.display  = 'inline'; 
		playlist_onchange(playlist_solo_select);
	}
	menu('edit');
	edit_num = effect_num;
	custom_mode = mode;
}

function save_playlist(){
	if (custom_mode == 1){
		output = "mode=4 ";
		for(var i=0; i < 10; i++){
			if (edit_num == i){
				output += playlist_duo_select.options[playlist_duo_select.selectedIndex].value
			}else{
				output += playlist_duo_array[i];
			}			
			output += " ";
		}
		post_text(output);
	}
	else if (custom_mode == 0){
		output = "mode=3 ";
		for(var i=0; i < 10; i++){
			if (edit_num == i){
				output += playlist_solo_select.options[playlist_solo_select.selectedIndex].value
			}else{
				output += playlist_solo_array[i];
			}			
			output += " ";
		}
		post_text(output);
	}
	menu('custom');
}
function mode_set(){
	if (requested_mode != "edit"){
		menuselecter.value = requested_mode;
	}
	edit_div.style.display  = 'none';  
	settings_div.style.display  = 'none';  
	imageWrapper.style.display  = 'none'; 
	playlist_div.style.display  = 'none'; 
	custom_div.style.display  = 'none'; 
	load_div.style.display  = 'none'; 
	if (loading == 0){
		switch(requested_mode) {
		case "preview":
			if (state_solo == 0 && state_duo == 0){ 
				playlist_div.style.display  = 'inline-block'; 
			}else{
				imageWrapper.style.display  = 'inline-block'; 
			}
			break;
		case "settings":
			settings_div.style.display  = 'inline-block'; 
			break;
		case "load":	
			load_div.style.display  = 'inline-block';  
			break;
		case "custom":	
			update_custom_buttons();
			custom_div.style.display  = 'inline-block';  
			break;
		case "edit":	
			edit_div.style.display  = 'inline-block';  
			break;
		}
	}
}
function post_button(button) {
	requested_mode = "preview";
	mode_set();
	post_text("mode=1 " + button);
}
function post_text(text){
	var request = new XMLHttpRequest();
	request.open('POST', 'index_post.php', true);
	request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
	request.send(text);
}
function wifi_channel_onchange(thing){
	var number = parseInt(thing.value);
	var request = new XMLHttpRequest();
	request.open('POST', 'wifiap.php', true);
	request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
	request.send("channel=" + number);
}
function ir_select_onchange(thing){
	var number = parseInt(thing.value);
	if (number >= 0 && number <= 1024){
		post_text("mode=2 " + number);
	}	
}
function effect_name(a) {
	switch(a) {
	case -1:	return "RESTART";
	case 0:		return "BLANK";
	case 1:		return "TEST";
	case 2:		return "TEST_CUBE";	
	case 3:		return "CAMERA";	
	case 4:		return "NORMAL";
	case 10:	return "JESS";
	case 11:	return "INFINITE";
	case 12:	return "JAKDAW";
	case 13:	return "OINKSIE";
	case 14:	return "GOOM";
	case 15:	return "GOOM2K1";
	case 19:	return "RADIOACT";
	case 20:	return "REV";
	case 21:	return "AGING";
	case 22:	return "DICE";
	case 23:	return "WARP";
	case 24:	return "SHAGADELIC";
	case 25:	return "VERTIGO";
	case 26:	return "KALEIDOSCOPE";
	case 27:	return "MARBLE";		
	case 28:	return "RIPPLE";
	case 29:	return "EDGE";	
	case 30:	return "GL_CUBE";
	case 31:	return "GL_MIRROR";
	case 32:	return "GL_SQUEEZE";
	case 33:	return "GL_STRETCH";
	case 34:	return "GL_TUNNEL";
	case 35:	return "GL_TWIRL";
	case 36:	return "GL_BULGE";
	case 37:	return "GLHEAT";		
	case 50:	return "MOVIE1";
	case 51:	return "MOVIE2";
	case 52:	return "MOVIE3";
	case 53:	return "MOVIE4";
	case 54:	return "MOVIE5";
	case 55:	return "MOVIE6";
	case 56:	return "MOVIE7";
	case 57:	return "MOVIE8";		
	case 58:	return "MOVIE9";
	case 59:	return "MOVIE10";
	case 60:	return "MOVIE11";
	case 61:	return "MOVIE12";	
	default:	return "UKNOWN";
	}
}
function update_data() {
	var request = new XMLHttpRequest();
	request.onerror = function() {
		interval_obj = setTimeout(update_data,update_rate);
	}
	request.onload = function() {
		if (missed_packets > 2){
			missed_packets = Math.min(missed_packets,3);
			reinit_all();
		}
		if (this.status >= 200 && this.status < 400 ) {
			var res = this.response.split(" ");
			var packet_counter = parseInt(res[30]);
			if (isNaN(packet_counter) == true || packet_counter == last_packet_counter){
				missed_packets++;
				console.log("miss");
			}else{
				last_packet_counter = packet_counter;
				missed_packets = Math.max(missed_packets-2,0);
				
				//pop out of loading mode
				if (missed_packets == 0 && loading != 0){
					loading = 0;
					mode_set();	
				}

				state_solo = parseInt(res[0]);
				state_duo = parseInt(res[1]);
				
				//mode toggle
				gunmode = parseInt(res[31]);
				
				if (gunmode == 2){
					mode_toggle.value = "Duo"
				}else if (gunmode == 1){
					mode_toggle.value = "Solo"
				}
				
				var ir_pwm = parseInt(res[3]);
				if (ir_pwm_last != ir_pwm){
					//top option is current setting
					ir_select.options[0].text = ir_pwm;
					ir_select.value = "1025";
					ir_pwm_last= ir_pwm;
				}
				
				var connected = parseInt(res[2]);
				if (connected != connected_last){
					if (connected == 1 ){
						connected_div.innerHTML = "Guns are Connected";
					}else{
						connected_div.innerHTML = "Other Gun is Disconnected";
					}
					connected_last = connected;
				}
				
				var changes = 0;
				for (i = 0; i < 10; i++) { 
					var num = parseInt(res[4+i]);
					if (playlist_solo_array[i] != num){
						playlist_solo_array[i] = num;
						changes++;
					}
				}
				if (changes > 0){
					var tempstring = "<b><u>SOLO PLAYLIST</u></b><br>";
					for (i = 0; i < 10; i++){
						if (playlist_solo_array[i] == -1){ break; }
						tempstring += effect_name(playlist_solo_array[i]) + "<br>"
					}
					playlist_solo_text.innerHTML = tempstring;
				}
				
				var changes2 = 0;
				for (i = 0; i < 10; i++) { 
					var num = parseInt(res[15+i]);
					if (playlist_duo_array[i] != num){
						playlist_duo_array[i] = num;
						changes2++;
					}
				}
				if (changes2 > 0){
					var tempstring = "<b><u>DUO PLAYLIST</u></b><br>";
					for (i = 0; i < 10; i++){
						if (playlist_duo_array[i] == -1){ break; }
						tempstring += effect_name(playlist_duo_array[i]) + "<br>"
					}
					playlist_duo_text.innerHTML = tempstring;
				}
				
				//dont bother updating buttons if we are not displaying them
				if ((changes != 0 || changes2 != 0) && requested_mode == "custom" ){
					update_custom_buttons();
				}
				
				effect_solo = parseInt(res[14]);
				effect_duo = parseInt(res[25]);

				var arduino_battery_level = parseFloat(res[26]);
				var arduino_temp = Math.floor(parseFloat(res[27]));
				var core_temp = Math.floor(parseFloat(res[28]));
				var latency = Math.floor(parseFloat(res[29]));
				
				if ((arduino_battery_level != arduino_battery_level_last) || (latency != latency_last)){
					batt_div.innerHTML = arduino_battery_level + "V<br>" + latency + "ms";
					arduino_battery_level_last = arduino_battery_level;
					latency_last = latency;
				}
				
				if ( (arduino_temp != arduino_temp_last) || (core_temp != core_temp_last) ){
					temp_div.innerHTML = arduino_temp + "F<br>" + core_temp + "F";
					arduino_temp_last = arduino_temp;
					core_temp_last = core_temp;
				}
				
				if((state_solo != state_solo_last || state_duo != state_duo_last) && loading == 0){
					if (state_solo == 0 && state_duo == 0){
						portal_color = -1;
						portal_text.innerHTML = "";
						portal_back.src = "blank.png";
						portal_front.src = "blank.png";
						
						primary_fire.value = "Primary"
						primary_fire.style.backgroundColor = "orange";
						primary_fire.style.color = "black";
						
						alt_fire.value = "Alt"
						alt_fire.style.backgroundColor = "blue";
						alt_fire.style.color = "white";
						
					}
					else if (state_solo > 0 || state_duo > 0){
						primary_fire.style.backgroundColor = "orange";
						primary_fire.style.color = "black";

						alt_fire.style.backgroundColor = "";
						alt_fire.style.color = "";
						
						primary_fire.value = (state_solo + state_duo); //postive value only, add them togehter
					}
					else if (state_solo < 0 || state_duo < 0){
					
						primary_fire.style.backgroundColor = "blue";
						primary_fire.style.color = "white";
						
						alt_fire.style.backgroundColor = "";
						alt_fire.style.color = "";
		
						primary_fire.value = (state_solo + state_duo) * -1; //postive value only, add them togehter
					
						
					}
					update_portal_forground();
					update_portal_background();
					mode_set();
					state_duo_last = state_duo;
					state_solo_last = state_solo;
				}
			}
		}else{
			missed_packets++;
		}	
		interval_obj = setTimeout(update_data,update_rate);
	}
	request.open("GET", "/tmp/portal.txt", true);
	request.send(null);
}

function update_portal_forground() {
	if ((state_solo > 0 || state_duo > 0) && portal_color != 0){
		if (portal_type == "GIF"){
			portal_front.src = "orange.gif";
			portal_svg1.style.display = "none";
		}else if (portal_type == "PNG"){
			portal_front.src = "orange_portal.png";
			portal_svg1.style.display = "none";
		}else if (portal_type == "SVG"){
			portal_svg1.style.fill="#F79126";
			portal_svg1.style.display = "inline";
			portal_front.src = "mask.png";
		}
		portal_color = 0;
	}
	else if ((state_solo < 0 || state_duo < 0) && portal_color != 1){
		if (portal_type == "GIF"){
			portal_front.src = "blue.gif";
			portal_svg1.style.display = "none";
		}else if (portal_type == "PNG"){
			portal_front.src = "blue_portal.png";
			portal_svg1.style.display = "none";			
		}else if (portal_type == "SVG"){
			portal_svg1.style.fill="#16ABE3";
			portal_svg1.style.display = "inline";
			portal_front.src = "mask.png";
		}
		portal_color = 1;
	}	
}
function update_portal_background() {
	if (state_duo < 0){
		portal_text.innerHTML = effect_name(3);
		if (preview_camera == "LIVE"){
			portal_back.src = "http://" + location.host + ":8080/?action=stream";
		}else if (preview_camera == "GIF"){
			portal_back.src = effect_preview(3);
		}else{
			portal_back.src = "";
		}
	}
	else if (state_duo > 0){
		portal_text.innerHTML = effect_name(effect_duo);
		if (preview_project == "LIVE"){
			if (effect_duo >= 10 && effect_duo < 19){
				portal_back.src = "http://" + location.host + ":8080/?action=stream";
			}else{
				portal_back.src = effect_preview(effect_duo);
			}
		}else if (preview_project == "GIF"){
			portal_back.src = effect_preview(effect_duo);
		}else{
			portal_back.src = "";
		}
	}else if (state_solo < 0 || state_solo > 0){
		portal_text.innerHTML = effect_name(effect_solo);
		if (preview_project == "LIVE"){
			if (effect_solo >= 10 && effect_solo < 19){
				portal_back.src = "http://" + location.host + ":8080/?action=stream";
			}else{
				portal_back.src = effect_preview(effect_solo);
			}
		}else if (preview_project == "GIF"){
			portal_back.src = effect_preview(effect_solo);
		}else{
			portal_back.src = "";
		}
	}
}
function setCookie(cname, cvalue, exdays) {
	var d = new Date();
	d.setTime(d.getTime() + (exdays*24*60*60*1000));
	var expires = "expires="+d.toUTCString();
	document.cookie = cname + "=" + cvalue + "; " + expires;
}
function getCookie(cname) {
	var name = cname + "=";
	var ca = document.cookie.split(';');
	for(var i=0; i<ca.length; i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1);
		if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
	}
	return "";
}
</script>
</body>
</html>